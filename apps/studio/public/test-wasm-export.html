<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrepFlow WASM Export Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #0a0a0a;
      color: #e0e0e0;
    }
    h1 {
      color: #3b82f6;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }
    .test-section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .status.info { background: #1e3a5f; border-left: 4px solid #3b82f6; }
    .status.success { background: #1e4620; border-left: 4px solid #10b981; }
    .status.error { background: #4c1d1d; border-left: 4px solid #ef4444; }
    .status.warning { background: #4a3e1a; border-left: 4px solid #f59e0b; }
    #log {
      background: #0d0d0d;
      border: 1px solid #333;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .log-entry {
      margin: 2px 0;
      padding: 2px 5px;
    }
    .log-entry.info { color: #60a5fa; }
    .log-entry.success { color: #34d399; }
    .log-entry.error { color: #f87171; }
    .log-entry.warning { color: #fbbf24; }
  </style>
</head>
<body>
  <h1>ðŸ”§ BrepFlow WASM Export Test</h1>

  <div class="test-section">
    <h2>1. Initialize WASM Worker</h2>
    <button onclick="initWASM()">Initialize WASM</button>
    <button onclick="checkStatus()">Check Status</button>
    <div id="init-status" class="status info">Ready to initialize...</div>
  </div>

  <div class="test-section">
    <h2>2. Create Test Geometry</h2>
    <button onclick="createBox()" disabled id="create-box">Create Box</button>
    <button onclick="createCylinder()" disabled id="create-cylinder">Create Cylinder</button>
    <button onclick="createSphere()" disabled id="create-sphere">Create Sphere</button>
    <div id="geometry-status" class="status info">Initialize WASM first...</div>
  </div>

  <div class="test-section">
    <h2>3. Export Geometry</h2>
    <button onclick="exportSTEP()" disabled id="export-step">Export STEP</button>
    <button onclick="exportSTL()" disabled id="export-stl">Export STL</button>
    <button onclick="exportIGES()" disabled id="export-iges">Export IGES</button>
    <div id="export-status" class="status info">Create geometry first...</div>
  </div>

  <div class="test-section">
    <h2>Console Log</h2>
    <div id="log"></div>
  </div>

  <script type="module">
    // Make functions available globally for onclick handlers
    window.initWASM = initWASM;
    window.checkStatus = checkStatus;
    window.createBox = createBox;
    window.createCylinder = createCylinder;
    window.createSphere = createSphere;
    window.exportSTEP = exportSTEP;
    window.exportSTL = exportSTL;
    window.exportIGES = exportIGES;

    let worker = null;
    let currentGeometry = null;
    let isInitialized = false;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const time = new Date().toTimeString().split(' ')[0];
      entry.textContent = `[${time}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function initWASM() {
      try {
        log('Starting WASM initialization...');
        updateStatus('init-status', 'Initializing WASM worker...', 'warning');

        // Create worker with proper WASM path
        worker = new Worker('/src/test-wasm-worker.js', { type: 'module' });

        // Set up message handler
        worker.onmessage = (event) => {
          const { type, data, error } = event.data;

          if (error) {
            log(`Worker error: ${error}`, 'error');
            return;
          }

          if (type === 'init-complete') {
            isInitialized = true;
            log('âœ… WASM initialized successfully!', 'success');
            updateStatus('init-status', 'WASM Ready! Engine initialized.', 'success');

            // Enable geometry buttons
            document.getElementById('create-box').disabled = false;
            document.getElementById('create-cylinder').disabled = false;
            document.getElementById('create-sphere').disabled = false;
            updateStatus('geometry-status', 'Ready to create geometry', 'info');
          }
        };

        worker.onerror = (error) => {
          log(`Worker error: ${error}`, 'error');
          updateStatus('init-status', 'Worker initialization failed', 'error');
        };

        // Send init message
        worker.postMessage({ type: 'init' });

      } catch (error) {
        log(`Failed to initialize: ${error.message}`, 'error');
        updateStatus('init-status', `Initialization failed: ${error.message}`, 'error');
      }
    }

    function checkStatus() {
      if (!worker) {
        log('Worker not created', 'warning');
        return;
      }

      log(`Worker initialized: ${isInitialized}`, isInitialized ? 'success' : 'warning');
      log(`Current geometry: ${currentGeometry ? currentGeometry.type : 'none'}`, 'info');

      if (currentGeometry) {
        log(`Geometry ID: ${currentGeometry.id}`, 'info');
      }
    }

    async function createBox() {
      if (!worker || !isInitialized) {
        log('WASM not initialized', 'error');
        return;
      }

      log('Creating box geometry...');

      return new Promise((resolve) => {
        const handler = (event) => {
          if (event.data.type === 'geometry-created') {
            currentGeometry = event.data.data;
            log(`âœ… Box created: ID ${currentGeometry.id}`, 'success');
            updateStatus('geometry-status', `Box created (ID: ${currentGeometry.id})`, 'success');
            enableExportButtons();
            worker.removeEventListener('message', handler);
            resolve();
          }
        };

        worker.addEventListener('message', handler);
        worker.postMessage({
          type: 'create-geometry',
          shape: 'box',
          params: { width: 100, height: 100, depth: 100 }
        });
      });
    }

    async function createCylinder() {
      if (!worker || !isInitialized) {
        log('WASM not initialized', 'error');
        return;
      }

      log('Creating cylinder geometry...');

      return new Promise((resolve) => {
        const handler = (event) => {
          if (event.data.type === 'geometry-created') {
            currentGeometry = event.data.data;
            log(`âœ… Cylinder created: ID ${currentGeometry.id}`, 'success');
            updateStatus('geometry-status', `Cylinder created (ID: ${currentGeometry.id})`, 'success');
            enableExportButtons();
            worker.removeEventListener('message', handler);
            resolve();
          }
        };

        worker.addEventListener('message', handler);
        worker.postMessage({
          type: 'create-geometry',
          shape: 'cylinder',
          params: { radius: 50, height: 100 }
        });
      });
    }

    async function createSphere() {
      if (!worker || !isInitialized) {
        log('WASM not initialized', 'error');
        return;
      }

      log('Creating sphere geometry...');

      return new Promise((resolve) => {
        const handler = (event) => {
          if (event.data.type === 'geometry-created') {
            currentGeometry = event.data.data;
            log(`âœ… Sphere created: ID ${currentGeometry.id}`, 'success');
            updateStatus('geometry-status', `Sphere created (ID: ${currentGeometry.id})`, 'success');
            enableExportButtons();
            worker.removeEventListener('message', handler);
            resolve();
          }
        };

        worker.addEventListener('message', handler);
        worker.postMessage({
          type: 'create-geometry',
          shape: 'sphere',
          params: { radius: 50 }
        });
      });
    }

    function enableExportButtons() {
      document.getElementById('export-step').disabled = false;
      document.getElementById('export-stl').disabled = false;
      document.getElementById('export-iges').disabled = false;
      updateStatus('export-status', 'Ready to export', 'info');
    }

    async function exportSTEP() {
      if (!currentGeometry) {
        log('No geometry to export', 'error');
        return;
      }

      log(`Exporting geometry ${currentGeometry.id} to STEP...`);
      updateStatus('export-status', 'Exporting to STEP...', 'warning');

      worker.postMessage({
        type: 'export',
        format: 'step',
        geometryId: currentGeometry.id
      });

      // Handle response
      const handler = (event) => {
        if (event.data.type === 'export-complete') {
          const { format, data } = event.data.data;
          log(`âœ… STEP export complete! Size: ${data.length} bytes`, 'success');
          updateStatus('export-status', `STEP exported (${data.length} bytes)`, 'success');
          downloadFile(data, `geometry.${format}`);
          worker.removeEventListener('message', handler);
        } else if (event.data.type === 'export-error') {
          log(`Export error: ${event.data.error}`, 'error');
          updateStatus('export-status', `Export failed: ${event.data.error}`, 'error');
          worker.removeEventListener('message', handler);
        }
      };

      worker.addEventListener('message', handler);
    }

    async function exportSTL() {
      if (!currentGeometry) {
        log('No geometry to export', 'error');
        return;
      }

      log(`Exporting geometry ${currentGeometry.id} to STL...`);
      updateStatus('export-status', 'Exporting to STL...', 'warning');

      worker.postMessage({
        type: 'export',
        format: 'stl',
        geometryId: currentGeometry.id
      });

      // Similar handler as STEP
    }

    async function exportIGES() {
      if (!currentGeometry) {
        log('No geometry to export', 'error');
        return;
      }

      log(`Exporting geometry ${currentGeometry.id} to IGES...`);
      updateStatus('export-status', 'Exporting to IGES...', 'warning');

      worker.postMessage({
        type: 'export',
        format: 'iges',
        geometryId: currentGeometry.id
      });

      // Similar handler as STEP
    }

    function updateStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status ${type}`;
    }

    function downloadFile(data, filename) {
      const blob = new Blob([data], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialize on page load
    log('BrepFlow WASM Export Test Page Loaded', 'info');
    log('Click "Initialize WASM" to start', 'info');
  </script>
</body>
</html>